# SmartRPA Background Service 系统架构

## 架构概览

SmartRPA Background Service 采用模块化设计，主要由以下几个核心部分组成：

```
+------------------+      +------------------+      +------------------+
|                  |      |                  |      |                  |
|   HTTP API层     |----->|   任务处理层     |----->|   浏览器自动化层  |
|                  |      |                  |      |                  |
+------------------+      +------------------+      +------------------+
                                   |
                                   v
                          +------------------+
                          |                  |
                          |   数据处理层     |
                          |                  |
                          +------------------+
```

## 核心组件

### 1. HTTP API 层 (server.js)

API 层负责接收和响应客户端请求，管理任务状态，并将任务分配给处理层。主要功能包括：

- 提供 RESTful API 接口
- 维护任务状态（运行中/已完成）
- 提供心跳检测机制
- 处理任务超时和取消请求

### 2. 任务处理层 (handler.js)

任务处理层负责实际执行任务逻辑，协调各个组件的工作。主要功能包括：

- 解析任务配置和参数
- 启动浏览器实例
- 协调任务执行流程
- 处理任务完成、失败等状态

### 3. 浏览器自动化层 (modules/puppeteerManager.js, modules/taskExecutor_*.js)

浏览器自动化层负责实际的网页操作和数据提取。主要功能包括：

- 浏览器实例管理
- 页面导航和交互
- 元素选择和操作
- 数据提取和处理

### 4. 数据处理层 (modules/dataProcessor.js, modules/outputHandler.js)

数据处理层负责处理和转换提取到的数据。主要功能包括：

- 数据清洗和格式化
- 数据转换和结构化
- 数据存储（文件、数据库、S3）

### 5. 任务管理 API (task_manager_api.js)

任务管理API是一个单独的服务，提供工作流定义和任务分配功能。主要功能包括：

- 工作流定义管理
- 任务队列管理
- 端点健康检查
- 任务状态监控

## 数据流

1. **任务提交**：客户端通过API提交任务请求
2. **任务分配**：API层创建任务ID并将任务传递给处理层
3. **浏览器操作**：处理层启动浏览器并执行自动化操作
4. **数据提取**：自动化层从网页中提取数据
5. **数据处理**：提取的数据经过处理和格式化
6. **结果返回**：处理后的数据返回给客户端或存储到指定位置

## 任务执行流程

```
+------------+     +------------+     +------------+     +------------+
|            |     |            |     |            |     |            |
| 任务提交   |---->| 预处理     |---->| 执行任务   |---->| 数据处理   |
|            |     |            |     |            |     |            |
+------------+     +------------+     +------------+     +------------+
                                          |
                                          v
                                    +------------+
                                    |            |
                                    | 返回结果   |
                                    |            |
                                    +------------+
```

1. **任务提交**：接收任务请求，验证参数，分配任务ID
2. **预处理**：加载配置，准备浏览器环境，加载Cookie
3. **执行任务**：按照任务定义执行网页操作和数据提取
4. **数据处理**：清洗和格式化提取到的数据
5. **返回结果**：将结果返回给客户端或存储到指定位置

## 扩展点

系统设计了多个扩展点，使其易于扩展：

1. **任务执行器**：通过创建新的TaskExecutor子类可以支持新的任务类型
2. **输出处理器**：通过OutputFactory模式可以添加新的输出格式
3. **事件处理器**：可以定义新的事件类型和处理逻辑
4. **浏览器管理**：支持多种浏览器启动和管理方式

## 部署架构

系统支持多种部署模式：

1. **单机部署**：所有组件在单台服务器上运行
2. **容器化部署**：使用Docker容器化部署各组件
3. **云服务部署**：部署在Google Cloud等云平台上

## 安全考虑

1. **Cookie管理**：安全存储和使用会话Cookie
2. **超时控制**：防止长时间运行的任务占用资源
3. **错误处理**：防止错误泄露敏感信息
4. **资源限制**：限制单个任务可以使用的资源